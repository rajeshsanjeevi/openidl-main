pipeline {
    agent {
        node {
            label 'openidl'
        }
    }
    parameters {
        string defaultValue: '', description: 'Organization Name', name: 'org_name', trim:true
        string defaultValue: '', description: 'Environment (dev | test | prod)', name: 'env', trim: true
        choice choices: ['deploy_secrets', 'deploy_apps'], description: 'Choose deployment action', name: 'deploy_action'
        }
    stages{
        stage('DeployOpenIDLSecrets'){
           steps {
                script {
                    org = params.org_name.substring(0,4)
                    if (${params.deploy_action} == "deploy_secrets") {
                        action = "secrets"
                    } else {
                        action "apps"
                    }
                }
                wrap([$class: 'AnsiColorBuildWrapper', colorMapName: "xterm"]) {
                    ansibleTower(
                        towerServer: 'AWX',
                        towerCredentialsId: 'AWX',
                        templateType: 'job',
                        jobTemplate: "${org}-${params.env}-openidl-${action}",
                        jobType: "run",
                        towerLogLevel: 'full',
                        removeColor: false,
                        async: false,
                        importTowerLogs: true,
                        extraVars: """---
                        org_name: '${org}'
                        env: '${params.env}'
                        """
                        )
                }
            }
        }
    }
    post {
        success {
            echo "The OpenIDL action: ${} is successful. Review logs"
        }
        failure {
            echo "The OpenIDL action: ${} is failed. Please investigate"
        }
    }
}

